<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上传音乐 - 音乐分享站</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="images/icon.png" type="image/png">
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="images/logo.png" alt="音乐分享站">
            <h1>音乐分享站</h1>
        </div>
        <nav>
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i> 首页</a></li>
                <li><a href="upload.html" class="active"><i class="fas fa-cloud-upload-alt"></i> 上传音乐</a></li>
            </ul>
        </nav>
    </header>
    
    <main class="upload-container">
        <div class="upload-header">
            <h2><i class="fas fa-cloud-upload-alt"></i> 上传音乐</h2>
            <p>分享你的音乐作品，让更多人听到你的声音</p>
        </div>
        
        <div class="upload-form-container">
            <form id="upload-form">
                <div class="form-group">
                    <label for="song-count"><i class="fas fa-list-ol"></i> 选择上传歌曲数量</label>
                    <select id="song-count" required>
                        <option value="1">1首歌曲</option>
                        <option value="2">2首歌曲</option>
                    </select>
                </div>
                
                <div id="song-inputs-container">
                    <!-- 歌曲输入区域将动态生成 -->
                </div>
                
                <button type="submit" class="btn" id="upload-btn">
                    <i class="fas fa-upload"></i> 上传音乐
                </button>
            </form>
            
            <div class="upload-status" id="upload-status">
                <!-- 上传状态信息会显示在这里 -->
            </div>
            
            <div class="share-link" id="share-link-container" style="display:none;">
                <h3><i class="fas fa-link"></i> 分享链接</h3>
                <div class="link-box">
                    <input type="text" id="share-link" readonly>
                    <button id="copy-link"><i class="fas fa-copy"></i> 复制</button>
                </div>
                <p class="note">复制此链接分享给朋友，他们可以收听和下载你的音乐</p>
            </div>
        </div>
    </main>
    
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 音乐分享站 | 用音乐连接你我</p>
            <div class="social-links">
                <a href="#"><i class="fab fa-github"></i></a>
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
            </div>
        </div>
    </footer>
    
    <script>
        // Cloudinary配置
        const CLOUD_NAME = 'dc5rhyjth';
        const UPLOAD_PRESET = 'music_share';
        const API_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            const songCountSelect = document.getElementById('song-count');
            const songInputsContainer = document.getElementById('song-inputs-container');
            
            // 生成歌曲输入区域
            function generateSongInputs(count) {
                songInputsContainer.innerHTML = '';
                
                for (let i = 1; i <= count; i++) {
                    const songInputDiv = document.createElement('div');
                    songInputDiv.className = 'song-input-group';
                    songInputDiv.innerHTML = `
                        <div class="form-group">
                            <label><i class="fas fa-music"></i> 歌曲 ${i} 信息</label>
                        </div>
                        <div class="form-group">
                            <label for="song-title-${i}"><i class="fas fa-heading"></i> 歌曲名称</label>
                            <input type="text" id="song-title-${i}" required placeholder="输入歌曲名称">
                        </div>
                        
                        <div class="form-group">
                            <label for="artist-${i}"><i class="fas fa-user"></i> 艺术家</label>
                            <input type="text" id="artist-${i}" required placeholder="输入艺术家名称">
                        </div>
                        
                        <div class="form-group">
                            <label for="music-file-${i}"><i class="fas fa-file-audio"></i> 选择音乐文件</label>
                            <div class="file-upload-area" id="file-upload-area-${i}">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <p>拖放文件到此处或 <span class="browse-btn">浏览文件</span></p>
                                <p class="note">支持格式: MP3, FLAC | 大小限制: 1-100MB</p>
                                <input type="file" id="music-file-${i}" accept=".mp3,.flac,audio/*" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="lyrics-file-${i}"><i class="fas fa-file-alt"></i> 歌词文件 (可选)</label>
                            <div class="file-upload-area" id="lyrics-upload-area-${i}">
                                <div class="upload-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <p>拖放文件到此处或 <span class="browse-btn">浏览文件</span></p>
                                <p class="note">支持格式: LRC</p>
                                <input type="file" id="lyrics-file-${i}" accept=".lrc">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="cover-file-${i}"><i class="fas fa-image"></i> 专辑封面 (可选)</label>
                            <div class="file-upload-area" id="cover-upload-area-${i}">
                                <div class="upload-icon">
                                    <i class="fas fa-image"></i>
                                </div>
                                <p>拖放文件到此处或 <span class="browse-btn">浏览文件</span></p>
                                <p class="note">支持格式: JPG, PNG</p>
                                <input type="file" id="cover-file-${i}" accept=".jpg,.jpeg,.png">
                            </div>
                        </div>
                        
                        <div class="preview-area" id="preview-area-${i}" style="display:none;">
                            <h3><i class="fas fa-headphones"></i> 音频预览</h3>
                            <audio id="preview-audio-${i}" controls style="width:100%; margin-top:12px;"></audio>
                            <div id="file-list-${i}"></div>
                        </div>
                    `;
                    
                    songInputsContainer.appendChild(songInputDiv);
                    
                    // 为每个文件上传区域添加事件监听
                    setupFileUploadArea(i);
                }
            }
            
            // 设置文件上传区域
            function setupFileUploadArea(songIndex) {
                const fileUploadArea = document.getElementById(`file-upload-area-${songIndex}`);
                const fileInput = document.getElementById(`music-file-${songIndex}`);
                const browseBtn = fileUploadArea.querySelector('.browse-btn');
                
                browseBtn.addEventListener('click', () => {
                    fileInput.click();
                });
                
                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('dragover');
                });
                
                fileUploadArea.addEventListener('dragleave', () => {
                    fileUploadArea.classList.remove('dragover');
                });
                
                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('dragover');
                    
                    if (e.dataTransfer.files.length) {
                        fileInput.files = e.dataTransfer.files;
                        const event = new Event('change', { bubbles: true });
                        fileInput.dispatchEvent(event);
                    }
                });
                
                // 文件预览
                fileInput.addEventListener('change', function(e) {
                    const files = e.target.files;
                    if (files.length > 0) {
                        const previewArea = document.getElementById(`preview-area-${songIndex}`);
                        const previewAudio = document.getElementById(`preview-audio-${songIndex}`);
                        const fileList = document.getElementById(`file-list-${songIndex}`);
                        
                        previewArea.style.display = 'block';
                        
                        // 只预览第一个文件
                        const firstFile = files[0];
                        const objectUrl = URL.createObjectURL(firstFile);
                        previewAudio.src = objectUrl;
                        
                        // 显示文件列表
                        fileList.innerHTML = '<h4>已选择文件:</h4>';
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            const fileInfo = document.createElement('div');
                            fileInfo.className = 'file-item';
                            fileInfo.innerHTML = `
                                <i class="fas fa-music"></i>
                                <span>${file.name}</span>
                                <span class="file-size">(${(file.size/(1024*1024)).toFixed(2)}MB)</span>
                            `;
                            fileList.appendChild(fileInfo);
                        }
                    }
                });
                
                // 歌词文件上传区域
                const lyricsUploadArea = document.getElementById(`lyrics-upload-area-${songIndex}`);
                const lyricsInput = document.getElementById(`lyrics-file-${songIndex}`);
                const lyricsBrowseBtn = lyricsUploadArea.querySelector('.browse-btn');
                
                lyricsBrowseBtn.addEventListener('click', () => {
                    lyricsInput.click();
                });
                
                lyricsUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    lyricsUploadArea.classList.add('dragover');
                });
                
                lyricsUploadArea.addEventListener('dragleave', () => {
                    lyricsUploadArea.classList.remove('dragover');
                });
                
                lyricsUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    lyricsUploadArea.classList.remove('dragover');
                    
                    if (e.dataTransfer.files.length) {
                        lyricsInput.files = e.dataTransfer.files;
                    }
                });
                
                // 封面文件上传区域
                const coverUploadArea = document.getElementById(`cover-upload-area-${songIndex}`);
                const coverInput = document.getElementById(`cover-file-${songIndex}`);
                const coverBrowseBtn = coverUploadArea.querySelector('.browse-btn');
                
                coverBrowseBtn.addEventListener('click', () => {
                    coverInput.click();
                });
                
                coverUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    coverUploadArea.classList.add('dragover');
                });
                
                coverUploadArea.addEventListener('dragleave', () => {
                    coverUploadArea.classList.remove('dragover');
                });
                
                coverUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    coverUploadArea.classList.remove('dragover');
                    
                    if (e.dataTransfer.files.length) {
                        coverInput.files = e.dataTransfer.files;
                    }
                });
            }
            
            // 初始生成1首歌曲的输入区域
            generateSongInputs(1);
            
            // 监听歌曲数量变化
            songCountSelect.addEventListener('change', () => {
                const count = parseInt(songCountSelect.value);
                generateSongInputs(count);
            });
            
            // 上传表单处理
            document.getElementById('upload-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const songCount = parseInt(songCountSelect.value);
                const uploadBtn = document.getElementById('upload-btn');
                const statusDiv = document.getElementById('upload-status');
                
                // 重置状态
                statusDiv.innerHTML = '';
                
                // 验证输入
                let allValid = true;
                const musicList = [];
                const uploadPromises = [];
                
                for (let i = 1; i <= songCount; i++) {
                    const title = document.getElementById(`song-title-${i}`).value.trim();
                    const artist = document.getElementById(`artist-${i}`).value.trim();
                    const musicFile = document.getElementById(`music-file-${i}`).files[0];
                    const lyricsFile = document.getElementById(`lyrics-file-${i}`).files[0];
                    const coverFile = document.getElementById(`cover-file-${i}`).files[0];
                    
                    if (!title || !artist || !musicFile) {
                        statusDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-circle"></i> 请填写歌曲 ${i} 的所有必填信息</div>`;
                        allValid = false;
                        break;
                    }
                    
                    // 验证音乐文件
                    const validTypes = ['audio/mp3', 'audio/mpeg', 'audio/flac'];
                    if (!validTypes.includes(musicFile.type) && !musicFile.name.match(/\.(mp3|flac)$/i)) {
                        statusDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-circle"></i> 歌曲 ${i} 的音乐文件不是有效的音频文件 (仅支持MP3/FLAC)</div>`;
                        allValid = false;
                        break;
                    }
                    
                    // 文件大小限制 (1-100MB)
                    const minSize = 1 * 1024 * 1024; // 1MB
                    const maxSize = 100 * 1024 * 1024; // 100MB
                    if (musicFile.size < minSize || musicFile.size > maxSize) {
                        statusDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-circle"></i> 歌曲 ${i} 的音乐文件大小必须在1MB到100MB之间 (当前: ${(musicFile.size/(1024*1024)).toFixed(1)}MB)</div>`;
                        allValid = false;
                        break;
                    }
                    
                    // 验证歌词文件（如果存在）
                    if (lyricsFile) {
                        if (!lyricsFile.name.match(/\.(lrc)$/i)) {
                            statusDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-circle"></i> 歌曲 ${i} 的歌词文件不是有效的LRC文件</div>`;
                            allValid = false;
                            break;
                        }
                    }
                    
                    // 验证封面文件（如果存在）
                    if (coverFile) {
                        if (!coverFile.type.match(/image\/(jpeg|jpg|png)/i)) {
                            statusDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-circle"></i> 歌曲 ${i} 的封面文件不是有效的图片文件 (仅支持JPG/PNG)</div>`;
                            allValid = false;
                            break;
                        }
                    }
                }
                
                if (!allValid) return;
                
                try {
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上传中...';
                    statusDiv.innerHTML = '<div class="info"><i class="fas fa-info-circle"></i> 开始上传...</div>';
                    
                    // 为每个文件创建上传Promise
                    for (let i = 1; i <= songCount; i++) {
                        const title = document.getElementById(`song-title-${i}`).value.trim();
                        const artist = document.getElementById(`artist-${i}`).value.trim();
                        const musicFile = document.getElementById(`music-file-${i}`).files[0];
                        const lyricsFile = document.getElementById(`lyrics-file-${i}`).files[0];
                        const coverFile = document.getElementById(`cover-file-${i}`).files[0];
                        
                        // 生成唯一文件名
                        const randomString = Math.random().toString(36).substring(2, 10);
                        const musicFileName = `${Date.now()}_${randomString}`;
                        let lyricsFileName = '';
                        let coverFileName = '';
                        
        // 上传音乐文件
        const musicUploadPromise = uploadFile(musicFile, musicFileName, i, 'music')
          .then(url => {
            return {
              type: 'music',
              url,
              fileName: musicFileName
            };
          });
        uploadPromises.push(musicUploadPromise);
        
        // 上传歌词文件（如果存在）
        if (lyricsFile) {
          const lyricsUploadPromise = uploadFile(lyricsFile, `${musicFileName}_lyrics`, i, 'lyrics')
            .then(url => {
              return {
                type: 'lyrics',
                url,
                fileName: `${musicFileName}_lyrics`
              };
            });
          uploadPromises.push(lyricsUploadPromise);
        }
        
        // 上传封面文件（如果存在）
        if (coverFile) {
          const coverUploadPromise = uploadFile(coverFile, `${musicFileName}_cover`, i, 'cover')
            .then(url => {
              return {
                type: 'cover',
                url,
                fileName: `${musicFileName}_cover`
              };
            });
          uploadPromises.push(coverUploadPromise);
        }
        
        // 创建音乐数据对象
        const musicData = {
          title,
          artist,
          musicFileName,
          lyricsFileName: lyricsFile ? `${musicFileName}_lyrics` : '',
          coverFileName: coverFile ? `${musicFileName}_cover` : '',
          timestamp: Date.now()
        };
        
        musicList.push(musicData);
      }
      
      // 等待所有文件上传完成
      const results = await Promise.all(uploadPromises);
      
      // 更新音乐列表中的URL
      results.forEach(result => {
        if (result.type === 'music') {
          const songIndex = musicList.findIndex(song => song.musicFileName === result.fileName);
          if (songIndex !== -1) {
            musicList[songIndex].url = result.url;
          }
        } else if (result.type === 'lyrics') {
          const songIndex = musicList.findIndex(song => song.lyricsFileName === result.fileName);
          if (songIndex !== -1) {
            musicList[songIndex].lyricsUrl = result.url;
          }
        } else if (result.type === 'cover') {
          const songIndex = musicList.findIndex(song => song.coverFileName === result.fileName);
          if (songIndex !== -1) {
            musicList[songIndex].coverUrl = result.url;
          }
        }
      });
      
      // 生成分享链接
      const baseUrl = window.location.href.split('upload.html')[0];
      const shareLink = baseUrl + 'musiclist.html?music=' + encodeURIComponent(JSON.stringify(musicList));
      
      document.getElementById('share-link').value = shareLink;
      document.getElementById('share-link-container').style.display = 'block';
      
      // 显示成功消息
      statusDiv.innerHTML = '<div class="success"><i class="fas fa-check-circle"></i> 上传成功! 复制下方链接分享给朋友</div>';
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 上传新歌曲';
      
      // 重置表单
      document.getElementById('upload-form').reset();
      for (let i = 1; i <= songCount; i++) {
        document.getElementById(`preview-area-${i}`).style.display = 'none';
      }
      
      // 简单的庆祝效果
      statusDiv.innerHTML += '<div class="success-icon"><i class="fas fa-music"></i></div>';
      setTimeout(() => {
        const icon = document.querySelector('.success-icon');
        if (icon) icon.remove();
      }, 3000);
      
    } catch (error) {
      console.error("上传错误:", error);
      statusDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-circle"></i> ${error.message}</div>`;
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 重新上传';
    }
  });
  
  // 文件上传函数
  function uploadFile(file, fileName, songIndex, fileType = 'music') {
    return new Promise((resolve, reject) => {
      // 准备上传表单数据
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', UPLOAD_PRESET);
      formData.append('cloud_name', CLOUD_NAME);
      formData.append('public_id', fileName);
      
      // 创建进度显示
      const progressContainer = document.createElement('div');
      progressContainer.className = 'progress-container';
      progressContainer.innerHTML = `
        <div class="file-progress-info">
          <span>上传 "${file.name}" (${fileType}): </span>
          <span class="progress-percent">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress" id="upload-progress-${songIndex}-${fileType}" style="width:0%"></div>
        </div>
      `;
      document.getElementById('upload-status').appendChild(progressContainer);
      
      // 使用XMLHttpRequest上传以便跟踪进度
      const xhr = new XMLHttpRequest();
      
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          document.getElementById(`upload-progress-${songIndex}-${fileType}`).style.width = `${percent}%`;
          progressContainer.querySelector('.progress-percent').textContent = `${percent}%`;
        }
      });
      
      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            resolve(response.secure_url);
          } else {
            let errorMessage = '上传失败';
            try {
              const errorResponse = JSON.parse(xhr.responseText);
              errorMessage = errorResponse.error.message || errorMessage;
            } catch (e) {
              console.error('解析错误响应失败', e);
            }
            reject(new Error(`文件 "${file.name}" 上传失败: ${errorMessage}`));
          }
        }
      };
      
      xhr.open('POST', API_URL, true);
      xhr.send(formData);
    });
  }
  
  // 复制链接功能
  document.getElementById('copy-link').addEventListener('click', () => {
    const linkInput = document.getElementById('share-link');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999);
    
    try {
      navigator.clipboard.writeText(linkInput.value).then(() => {
        // 显示复制成功消息
        const statusDiv = document.getElementById('upload-status');
        const originalContent = statusDiv.innerHTML;
        statusDiv.innerHTML = '<div class="success"><i class="fas fa-check-circle"></i> 链接已复制到剪贴板!</div>';
        
        // 3秒后恢复原状态
        setTimeout(() => {
          if (document.getElementById('share-link-container').style.display === 'block') {
            statusDiv.innerHTML = originalContent;
          }
        }, 3000);
      });
    } catch (err) {
      // 降级方案
      document.execCommand('copy');
      const statusDiv = document.getElementById('upload-status');
      const originalContent = statusDiv.innerHTML;
      statusDiv.innerHTML = '<div class="success"><i class="fas fa-check-circle"></i> 链接已复制到剪贴板!</div>';
      
      setTimeout(() => {
        if (document.getElementById('share-link-container').style.display === 'block') {
          statusDiv.innerHTML = originalContent;
        }
      }, 3000);
    }
  });
});
    </script>
</body>
</html>